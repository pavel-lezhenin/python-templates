name: Monorepo CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.14"

jobs:
  security:
    name: Security Scan (Parent Repo Only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          allow-prereleases: true

      - run: pip install bandit
      - run: bandit -r scripts shared -c pyproject.toml || true

      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trigger-submodules:
    name: Trigger Child Repository CI
    runs-on: ubuntu-latest
    needs: [security]
    steps:
      - name: Trigger fast-simple-crud CI
        run: |
          gh api repos/pavel-lezhenin/fast-simple-crud/dispatches \
            -f event_type=parent_repo_update \
            -f client_payload[parent_run_id]=${{ github.run_id }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Trigger arch-layer-prod-mongo-fast CI
        run: |
          gh api repos/pavel-lezhenin/arch-layer-prod-mongo-fast/dispatches \
            -f event_type=parent_repo_update \
            -f client_payload[parent_run_id]=${{ github.run_id }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Trigger arch-hexagonal-postgresql-fast CI
        run: |
          gh api repos/pavel-lezhenin/arch-hexagonal-postgresql-fast/dispatches \
            -f event_type=parent_repo_update \
            -f client_payload[parent_run_id]=${{ github.run_id }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

  wait-for-submodules:
    name: Wait for Child CI Completion
    runs-on: ubuntu-latest
    needs: [trigger-submodules]
    steps:
      - name: Wait for fast-simple-crud CI
        run: |
          echo "‚è≥ Waiting for fast-simple-crud CI to complete..."
          for i in {1..60}; do
            status=$(gh api repos/pavel-lezhenin/fast-simple-crud/actions/runs \
              --jq '.workflow_runs[0].status')
            conclusion=$(gh api repos/pavel-lezhenin/fast-simple-crud/actions/runs \
              --jq '.workflow_runs[0].conclusion')

            if [[ "$status" == "completed" ]]; then
              if [[ "$conclusion" == "success" ]]; then
                echo "‚úÖ fast-simple-crud CI passed"
                break
              else
                echo "‚ùå fast-simple-crud CI failed: $conclusion"
                exit 1
              fi
            fi

            echo "  Status: $status (attempt $i/60)"
            sleep 10
          done
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Wait for arch-layer-prod-mongo-fast CI
        run: |
          echo "‚è≥ Waiting for arch-layer-prod-mongo-fast CI to complete..."
          for i in {1..60}; do
            status=$(gh api repos/pavel-lezhenin/arch-layer-prod-mongo-fast/actions/runs \
              --jq '.workflow_runs[0].status')
            conclusion=$(gh api repos/pavel-lezhenin/arch-layer-prod-mongo-fast/actions/runs \
              --jq '.workflow_runs[0].conclusion')

            if [[ "$status" == "completed" ]]; then
              if [[ "$conclusion" == "success" ]]; then
                echo "‚úÖ arch-layer-prod-mongo-fast CI passed"
                break
              else
                echo "‚ùå arch-layer-prod-mongo-fast CI failed: $conclusion"
                exit 1
              fi
            fi

            echo "  Status: $status (attempt $i/60)"
            sleep 10
          done
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Wait for arch-hexagonal-postgresql-fast CI
        run: |
          echo "‚è≥ Waiting for arch-hexagonal-postgresql-fast CI to complete..."
          for i in {1..60}; do
            status=$(gh api repos/pavel-lezhenin/arch-hexagonal-postgresql-fast/actions/runs \
              --jq '.workflow_runs[0].status')
            conclusion=$(gh api repos/pavel-lezhenin/arch-hexagonal-postgresql-fast/actions/runs \
              --jq '.workflow_runs[0].conclusion')

            if [[ "$status" == "completed" ]]; then
              if [[ "$conclusion" == "success" ]]; then
                echo "‚úÖ arch-hexagonal-postgresql-fast CI passed"
                break
              else
                echo "‚ùå arch-hexagonal-postgresql-fast CI failed: $conclusion"
                exit 1
              fi
            fi

            echo "  Status: $status (attempt $i/60)"
            sleep 10
          done
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

  notify-success:
    name: All CI Passed (Parent + Children)
    needs: [wait-for-submodules]
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "‚úÖ All CI checks passed!"
          echo "üì¶ Parent: Security scan completed"
          echo "üì¶ Children: All submodule CI workflows completed successfully"
          echo "   - fast-simple-crud: https://github.com/pavel-lezhenin/fast-simple-crud/actions"
          echo "   - arch-layer-prod-mongo-fast: https://github.com/pavel-lezhenin/arch-layer-prod-mongo-fast/actions"
          echo "   - arch-hexagonal-postgresql-fast: https://github.com/pavel-lezhenin/arch-hexagonal-postgresql-fast/actions"
